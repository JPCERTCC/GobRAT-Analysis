

import "elf"

rule malware_GobRAT_arm {
    meta:
        description = "Hunting GobRAT malware"
        author = "JPCERT/CC Incident Response Group"
        rule_usage = "Hunting"
        hash = "39438597FAF8D9A4024589847F2E7E441E3A9D63501B724FD9DDDA028A9B19FB"
    
    strings:
        /* Function Address: 0x26a4a0 : aaa.com_bbb_meutil._debug
        01 20 A0 E1                         MOV             R2, R1        
        B4 10 8D E2                         ADD             R1, SP, #0x118+var_64
        00 30 A0 E1                         MOV             R3, R0        
        00 00 A0 E3                         MOV             R0, #0        
        */
        $func0 = { 01 20 A0 E1 B4 10 8D E2 00 30 A0 E1 00 00 A0 E3 }

        /* Function Address: 0x2643b4 : aaa.com_bbb_menet.GetMacAddress
        01 40 84 E2                         ADD             R4, R4, #1    
        07 50 A0 E1                         MOV             R5, R7        
        01 00 54 E1                         CMP             R4, R1        
        */
        $func1 = { 01 40 84 E2 07 50 A0 E1 01 00 54 E1 }

        /* Function Address: 0x26b524 : aaa.com_bbb_meutil.GenerateTLSConfig
        01 30 A0 E1                         MOV             R3, R1        
        A8 10 8D E2                         ADD             R1, SP, #0x3E0+var_338
        00 40 A0 E1                         MOV             R4, R0        
        00 00 A0 E3                         MOV             R0, #0        
        */
        $func2 = { 01 30 A0 E1 A8 10 8D E2 00 40 A0 E1 00 00 A0 E3 }

        /* Function Address: 0x26b068 : aaa.com_bbb_meutil.GenerateRandomHex
        92 43 82 E0                         UMULL           R4, R2, R2, R3
        03 01 C0 E3                         BIC             R0, R0, #0xC0000000
        00 50 94 E0                         ADDS            R5, R4, R0    
        */
        $func3 = { 92 43 82 E0 03 01 C0 E3 00 50 94 E0 }

        /* Function Address: 0x26bdc0 : aaa.com_bbb_meutil.Daemon1
        00 50 E0 E3                         MOV             R5, #0xFFFFFFFF
        01 60 A0 E1                         MOV             R6, R1        
        9C 10 8D E2                         ADD             R1, SP, #0xC0+var_24
        00 70 A0 E1                         MOV             R7, R0        
        00 00 A0 E3                         MOV             R0, #0        
        */
        $func4 = { 00 50 E0 E3 01 60 A0 E1 9C 10 8D E2 00 70 A0 E1 00 00 A0 E3 }

        /* Function Address: 0x26c37c : aaa.com_bbb_meutil.Daemon2
        08 50 05 E2                         AND             R5, R5, #8    
        05 40 84 E0                         ADD             R4, R4, R5    
        01 50 42 E2                         SUB             R5, R2, #1    
        01 60 43 E2                         SUB             R6, R3, #1    
        06 00 52 E1                         CMP             R2, R6        
        */
        $func5 = { 08 50 05 E2 05 40 84 E0 01 50 42 E2 01 60 43 E2 06 00 52 E1 }


    condition:
        (uint32(0) == 0x464C457F)
        and (elf.machine == elf.EM_ARM)
        and (filesize < 9MB)
        and (filesize > 2MB)
        and ( 5 of ($func*) )
}


rule malware_GobRAT_mips {
    meta:
        description = "Hunting GobRAT malware"
        author = "JPCERT/CC Incident Response Group"
        rule_usage = "Hunting"
        hash = "DAD92DDC28A5DBD65671A8F3E958A818113058BEDE10924046B493F0AB195F00"
    
    strings:
        /* Function Address: 0x2873ac : aaa.com_bbb_mecrypt.AesEncrypt
        5F 00 01 3C 61 CB 21 24             li      $at, 0x5ECB61         
        5F 00 03 3C 70 CB 63 24             li      $v1, (aLittleendianmo+0x7555) # "h2384185791015625: value of type AEAD_A"...
        FF FF 21 24                         addiu   $at, (aLittleendianmo+0x7545 - 0x5ECB61) # "f12345678abcdefgh2384185791015625: valu"...
        */
        $func0 = { 5F 00 01 3C 61 CB 21 24 5F 00 03 3C 70 CB 63 24 FF FF 21 24 }

        /* Function Address: 0x2cb72c : aaa.com_bbb_menet._ptr_CONN.Read
        20 00 BD 27                         addiu   $sp, 0x20             
        08 00 E0 03                         jr      $ra                   
        00 00 00 00                         nop                           
        57 00 01 3C 20 32 21 24             li      $at, asc_573220 # "\b"
        */
        $func1 = { 20 00 BD 27 08 00 E0 03 00 00 00 00 57 00 01 3C 20 32 21 24 }

        /* Function Address: 0x2d3af0 : aaa.com_bbb_meutil._debug
        00 00 00 00                         nop                           
        40 10 02 00                         sll     $v0, 1                
        C2 1F 01 00                         srl     $v1, $at, 31          
        25 10 62 00                         or      $v0, $v1, $v0         
        40 18 01 00                         sll     $v1, $at, 1           
        40 20 02 00                         sll     $a0, $v0, 1           
        C2 1F 03 00                         srl     $v1, 31               
        25 18 83 00                         or      $v1, $a0, $v1         
        B1 D7 17 3C 80 7F F7 36             li      $s7, 0xD7B17F80       
        21 20 77 00                         addu    $a0, $v1, $s7         
        2B 18 83 00                         sltu    $v1, $a0, $v1         
        C2 17 02 00                         srl     $v0, 31               
        0D 00 42 24                         addiu   $v0, 0xD              
        21 10 43 00                         addu    $v0, $v1              
        */
        $func2 = { 00 00 00 00 40 10 02 00 C2 1F 01 00 25 10 62 00 40 18 01 00 40 20 02 00 C2 1F 03 00 25 18 83 00 B1 D7 17 3C 80 7F F7 36 21 20 77 00 2B 18 83 00 C2 17 02 00 0D 00 42 24 21 10 43 00 }

        /* Function Address: 0x2cc89c : aaa.com_bbb_menet.GetMacAddress
        00 00 00 00                         nop                           
        3A 00 0A 24                         li      $t2, 0x3A  # ':'      
        25 40 06 00                         move    $t0, $a2              
        01 00 06 25                         addiu   $a2, $t0, 1           
        00 4E 07 00                         sll     $t1, $a3, 24          
        02 4F 09 00                         srl     $t1, 28               
        FF 00 29 31                         andi    $t1, 0xFF             
        5F 00 0B 3C 51 CB 6B 25             li      $t3, (aLittleendianmo+0x7536) # "0123456789abcdef12345678abcdefgh2384185"...
        21 48 69 01                         addu    $t1, $t3, $t1         
        */
        $func3 = { 00 00 00 00 3A 00 0A 24 25 40 06 00 01 00 06 25 00 4E 07 00 02 4F 09 00 FF 00 29 31 5F 00 0B 3C 51 CB 6B 25 21 48 69 01 }

        /* Function Address: 0x2d43b4 : aaa.com_bbb_meutil.DebugError
        27 00 00 00                         nor     $zero, $zero          
        25 08 00 00                         move    $at, $zero            
        01 00 04 24                         li      $a0, 1                
        C7 00 05 3C 78 EA A5 24             li      $a1, dword_C6EA78     
        25 30 00 00                         move    $a2, $zero            
        0F 00 00 00                         sync                          
        */
        $func4 = { 27 00 00 00 25 08 00 00 01 00 04 24 C7 00 05 3C 78 EA A5 24 25 30 00 00 0F 00 00 00 }

        /* Function Address: 0x2d61c0 : aaa.com_bbb_meutil.Daemon2
        00 00 00 00                         nop                           
        FF FF 84 24                         addiu   $a0, -1               
        23 30 04 00                         negu    $a2, $a0              
        C3 37 06 00                         sra     $a2, 31               
        08 00 C6 30                         andi    $a2, 8                
        21 18 C3 00                         addu    $v1, $a2, $v1         
        FF FF A6 24                         addiu   $a2, $a1, -1          
        2B 38 85 00                         sltu    $a3, $a0, $a1         
        */
        $func5 = { 00 00 00 00 FF FF 84 24 23 30 04 00 C3 37 06 00 08 00 C6 30 21 18 C3 00 FF FF A6 24 2B 38 85 00 }

    condition:
        (uint32(0) == 0x464C457F)
        and (filesize < 9MB)
        and (filesize > 2MB)
        and ( 6 of ($func*) )
}


rule malware_GobRAT_x86 {
    meta:
        description = "Hunting GobRAT malware"
        author = "JPCERT/CC Incident Response Group"
        rule_usage = "Hunting"
        hash = "8E628C6E997ABF2C5107BF3E196F339D5A0592053CE667719936EC68A4C3A02F"
    
    strings:
        /* Function Address: 0x828bfe0 : aaa.com_bbb_menet.Receive
        C1 E0 18                            shl     eax, 18h              
        09 C8                               or      eax, ecx              
        3D 00 E8 03 00                      cmp     eax, 3E800h           
        */
        $func0 = { C1 E0 18 09 C8 3D 00 E8 03 00 }

        /* Function Address: 0x8292540 : aaa.com_bbb_meutil._debug
        D1 E1                               shl     ecx, 1                
        89 C2                               mov     edx, eax              
        C1 E8 1F                            shr     eax, 1Fh              
        09 C8                               or      eax, ecx              
        89 D1                               mov     ecx, edx              
        D1 E2                               shl     edx, 1                
        89 C3                               mov     ebx, eax              
        D1 E0                               shl     eax, 1                
        C1 EA 1F                            shr     edx, 1Fh              
        09 D0                               or      eax, edx              
        89 C2                               mov     edx, eax              
        05 80 7F B1 D7                      add     eax, 0D7B17F80h       
        C1 EB 1F                            shr     ebx, 1Fh              
        81 C2 80 7F B1 D7                   add     edx, 0D7B17F80h       
        83 D3 0D                            adc     ebx, 0Dh              
        */
        $func1 = { D1 E1 89 C2 C1 E8 1F 09 C8 89 D1 D1 E2 89 C3 D1 E0 C1 EA 1F 09 D0 89 C2 05 80 7F B1 D7 C1 EB 1F 81 C2 80 7F B1 D7 83 D3 0D }

        /* Function Address: 0x828c280 : aaa.com_bbb_menet.Send
        29 C5                               sub     ebp, eax              
        89 EF                               mov     edi, ebp              
        87 DD                               xchg    ebx, ebp              
        F7 DB                               neg     ebx                   
        87 DD                               xchg    ebx, ebp              
        C1 FD 1F                            sar     ebp, 1Fh              
        21 C5                               and     ebp, eax              
        01 D5                               add     ebp, edx              
        */
        $func2 = { 29 C5 89 EF 87 DD F7 DB 87 DD C1 FD 1F 21 C5 01 D5 }

        /* Function Address: 0x828ca90 : aaa.com_bbb_menet.GetMacAddress
        97                                  xchg    eax, edi              
        C0 E8 04                            shr     al, 4                 
        97                                  xchg    eax, edi              
        97                                  xchg    eax, edi              
        0F B6 C0                            movzx   eax, al               
        97                                  xchg    eax, edi              
        */
        $func3 = { 97 C0 E8 04 97 97 0F B6 C0 97 }

        /* Function Address: 0x82936a0 : aaa.com_bbb_meutil.GenerateTLSConfig
        B9 AA 00 00 00                      mov     ecx, 0AAh             
        89 C2                               mov     edx, eax              
        31 C0                               xor     eax, eax              
        */
        $func4 = { B9 AA 00 00 00 89 C2 31 C0 }

        /* Function Address: 0x82944b0 : aaa.com_bbb_meutil.Daemon2
        4D                                  dec     ebp                   
        89 EE                               mov     esi, ebp              
        87 DD                               xchg    ebx, ebp              
        F7 DB                               neg     ebx                   
        87 DD                               xchg    ebx, ebp              
        C1 FD 1F                            sar     ebp, 1Fh              
        83 E5 08                            and     ebp, 8                
        01 EB                               add     ebx, ebp              
        39 F2                               cmp     edx, esi              
        */
        $func5 = { 4D 89 EE 87 DD F7 DB 87 DD C1 FD 1F 83 E5 08 01 EB 39 F2 }

        /* Function Address: 0x82948d0 : aaa.com_bbb_meutil.SimpleCommand
        C1 FB 1F                            sar     ebx, 1Fh              
        69 DB 00 CA 9A 3B                   imul    ebx, 3B9ACA00h        
        */
        $func6 = { C1 FB 1F 69 DB 00 CA 9A 3B }


    condition:
        (uint32(0) == 0x464C457F)
        and (elf.machine == elf.EM_386)
        and (filesize < 9MB)
        and (filesize > 2MB)
        and ( 6 of ($func*) )
}


rule malware_GobRAT_x8664 {
    meta:
        description = "Hunting GobRAT malware"
        author = "JPCERT/CC Incident Response Group"
        rule_usage = "Hunting"
        hash = "4CBDA1E061085BB0CFC948B2EB9C3441F27D8CE5B233199BCCA315E95D7243CC"
    
    strings:
        /* Function Address: 0x5f6160 : aaa.com_bbb_mecrypt.AesEncrypt
        31 C0                               xor     eax, eax              
        31 DB                               xor     ebx, ebx              
        48 89 FE                            mov     rsi, rdi              
        48 89 CF                            mov     rdi, rcx              
        48 89 D9                            mov     rcx, rbx              
        */
        $func0 = { 31 C0 31 DB 48 89 FE 48 89 CF 48 89 D9 }

        /* Function Address: 0x63fe80 : aaa.com_bbb_meutil._debug
        48 B8 CC 52 5A 9B A0 2F B8 44       mov     rax, 44B82FA09B5A52CCh
        48 F7 EB                            imul    rbx                   
        48 C1 FA 1C                         sar     rdx, 1Ch              
        48 C1 FB 3F                         sar     rbx, 3Fh              
        48 29 DA                            sub     rdx, rbx              
        48 69 D2 00 CA 9A 3B                imul    rdx, 3B9ACA00h        
        48 29 D1                            sub     rcx, rdx              
        48 BA 00 00 1A 3D EB 03 B2 A1       mov     rdx, 0A1B203EB3D1A0000h
        */
        $func1 = { 48 B8 CC 52 5A 9B A0 2F B8 44 48 F7 EB 48 C1 FA 1C 48 C1 FB 3F 48 29 DA 48 69 D2 00 CA 9A 3B 48 29 D1 48 BA 00 00 1A 3D EB 03 B2 A1 }

        /* Function Address: 0x639500 : aaa.com_bbb_menet.Send
        48 29 C7                            sub     rdi, rax              
        4C 89 C1                            mov     rcx, r8               
        48 29 C1                            sub     rcx, rax              
        49 89 FA                            mov     r10, rdi              
        48 F7 DF                            neg     rdi                   
        48 C1 FF 3F                         sar     rdi, 3Fh              
        48 21 C7                            and     rdi, rax              
        */
        $func2 = { 48 29 C7 4C 89 C1 48 29 C1 49 89 FA 48 F7 DF 48 C1 FF 3F 48 21 C7 }

        /* Function Address: 0x640b00 : aaa.com_bbb_meutil.GenerateRandomHex
        48 89 D6                            mov     rsi, rdx              
        48 69 CB 00 CA 9A 3B                imul    rcx, rbx, 3B9ACA00h   
        81 E6 FF FF FF 3F                   and     esi, 3FFFFFFFh        
        48 63 D6                            movsxd  rdx, esi              
        48 01 D1                            add     rcx, rdx              
        48 BA 00 00 1A 3D EB 03 B2 A1       mov     rdx, 0A1B203EB3D1A0000h
        */
        $func3 = { 48 89 D6 48 69 CB 00 CA 9A 3B 81 E6 FF FF FF 3F 48 63 D6 48 01 D1 48 BA 00 00 1A 3D EB 03 B2 A1 }

        /* Function Address: 0x6426a0 : aaa.com_bbb_meutil.init
        81 E2 FF FF FF 3F                   and     edx, 3FFFFFFFh        
        48 63 D2                            movsxd  rdx, edx              
        48 01 D1                            add     rcx, rdx              
        48 BA 00 00 1A 3D EB 03 B2 A1       mov     rdx, 0A1B203EB3D1A0000h
        */
        $func4 = { 81 E2 FF FF FF 3F 48 63 D2 48 01 D1 48 BA 00 00 1A 3D EB 03 B2 A1 }

        /* Function Address: 0x641e00 : aaa.com_bbb_meutil.Daemon2
        48 FF CF                            dec     rdi                   
        49 89 F8                            mov     r8, rdi               
        48 F7 DF                            neg     rdi                   
        48 C1 FF 3F                         sar     rdi, 3Fh              
        83 E7 10                            and     edi, 10h              
        48 01 FA                            add     rdx, rdi              
        */
        $func5 = { 48 FF CF 49 89 F8 48 F7 DF 48 C1 FF 3F 83 E7 10 48 01 FA }

        /* Function Address: 0x6421e0 : aaa.com_bbb_meutil.SimpleCommand
        31 C9                               xor     ecx, ecx              
        31 FF                               xor     edi, edi              
        BE 02 00 00 00                      mov     esi, 2                
        41 B8 01 00 00 00                   mov     r8d, 1                
        */
        $func6 = { 31 C9 31 FF BE 02 00 00 00 41 B8 01 00 00 00 }

    condition:
        (uint32(0) == 0x464C457F)
        and (elf.machine == elf.EM_X86_64)
        and (filesize < 9MB)
        and (filesize > 2MB)
        and ( 5 of ($func*) )
}