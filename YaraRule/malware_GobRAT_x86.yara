

import "elf"

rule malware_GobRAT_x86 {
    meta:
        description = "Hunting GobRAT malware"
        author = "JPCERT/CC Incident Response Group"
        rule_usage = "Hunting"
        hash = "8E628C6E997ABF2C5107BF3E196F339D5A0592053CE667719936EC68A4C3A02F"
    
    strings:
        /* Function Address: 0x828bfe0 : aaa.com_bbb_menet.Receive
        C1 E0 18                            shl     eax, 18h              
        09 C8                               or      eax, ecx              
        3D 00 E8 03 00                      cmp     eax, 3E800h           
        */
        $func0 = { C1 E0 18 09 C8 3D 00 E8 03 00 }

        /* Function Address: 0x8292540 : aaa.com_bbb_meutil._debug
        D1 E1                               shl     ecx, 1                
        89 C2                               mov     edx, eax              
        C1 E8 1F                            shr     eax, 1Fh              
        09 C8                               or      eax, ecx              
        89 D1                               mov     ecx, edx              
        D1 E2                               shl     edx, 1                
        89 C3                               mov     ebx, eax              
        D1 E0                               shl     eax, 1                
        C1 EA 1F                            shr     edx, 1Fh              
        09 D0                               or      eax, edx              
        89 C2                               mov     edx, eax              
        05 80 7F B1 D7                      add     eax, 0D7B17F80h       
        C1 EB 1F                            shr     ebx, 1Fh              
        81 C2 80 7F B1 D7                   add     edx, 0D7B17F80h       
        83 D3 0D                            adc     ebx, 0Dh              
        */
        $func1 = { D1 E1 89 C2 C1 E8 1F 09 C8 89 D1 D1 E2 89 C3 D1 E0 C1 EA 1F 09 D0 89 C2 05 80 7F B1 D7 C1 EB 1F 81 C2 80 7F B1 D7 83 D3 0D }

        /* Function Address: 0x828c280 : aaa.com_bbb_menet.Send
        29 C5                               sub     ebp, eax              
        89 EF                               mov     edi, ebp              
        87 DD                               xchg    ebx, ebp              
        F7 DB                               neg     ebx                   
        87 DD                               xchg    ebx, ebp              
        C1 FD 1F                            sar     ebp, 1Fh              
        21 C5                               and     ebp, eax              
        01 D5                               add     ebp, edx              
        */
        $func2 = { 29 C5 89 EF 87 DD F7 DB 87 DD C1 FD 1F 21 C5 01 D5 }

        /* Function Address: 0x828ca90 : aaa.com_bbb_menet.GetMacAddress
        97                                  xchg    eax, edi              
        C0 E8 04                            shr     al, 4                 
        97                                  xchg    eax, edi              
        97                                  xchg    eax, edi              
        0F B6 C0                            movzx   eax, al               
        97                                  xchg    eax, edi              
        */
        $func3 = { 97 C0 E8 04 97 97 0F B6 C0 97 }

        /* Function Address: 0x82936a0 : aaa.com_bbb_meutil.GenerateTLSConfig
        B9 AA 00 00 00                      mov     ecx, 0AAh             
        89 C2                               mov     edx, eax              
        31 C0                               xor     eax, eax              
        */
        $func4 = { B9 AA 00 00 00 89 C2 31 C0 }

        /* Function Address: 0x82944b0 : aaa.com_bbb_meutil.Daemon2
        4D                                  dec     ebp                   
        89 EE                               mov     esi, ebp              
        87 DD                               xchg    ebx, ebp              
        F7 DB                               neg     ebx                   
        87 DD                               xchg    ebx, ebp              
        C1 FD 1F                            sar     ebp, 1Fh              
        83 E5 08                            and     ebp, 8                
        01 EB                               add     ebx, ebp              
        39 F2                               cmp     edx, esi              
        */
        $func5 = { 4D 89 EE 87 DD F7 DB 87 DD C1 FD 1F 83 E5 08 01 EB 39 F2 }

        /* Function Address: 0x82948d0 : aaa.com_bbb_meutil.SimpleCommand
        C1 FB 1F                            sar     ebx, 1Fh              
        69 DB 00 CA 9A 3B                   imul    ebx, 3B9ACA00h        
        */
        $func6 = { C1 FB 1F 69 DB 00 CA 9A 3B }


    condition:
        (uint32(0) == 0x464C457F)
        and (elf.machine == elf.EM_386)
        and (filesize < 9MB)
        and (filesize > 2MB)
        and ( 6 of ($func*) )

}
    