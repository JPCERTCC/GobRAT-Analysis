

import "elf"

rule malware_GobRAT_x8664 {
    meta:
        description = "Hunting GobRAT malware"
        author = "JPCERT/CC Incident Response Group"
        rule_usage = "Hunting"
        hash = "4CBDA1E061085BB0CFC948B2EB9C3441F27D8CE5B233199BCCA315E95D7243CC"
    
    strings:
        /* Function Address: 0x5f6160 : aaa.com_bbb_mecrypt.AesEncrypt
        31 C0                               xor     eax, eax              
        31 DB                               xor     ebx, ebx              
        48 89 FE                            mov     rsi, rdi              
        48 89 CF                            mov     rdi, rcx              
        48 89 D9                            mov     rcx, rbx              
        */
        $func0 = { 31 C0 31 DB 48 89 FE 48 89 CF 48 89 D9 }

        /* Function Address: 0x63fe80 : aaa.com_bbb_meutil._debug
        48 B8 CC 52 5A 9B A0 2F B8 44       mov     rax, 44B82FA09B5A52CCh
        48 F7 EB                            imul    rbx                   
        48 C1 FA 1C                         sar     rdx, 1Ch              
        48 C1 FB 3F                         sar     rbx, 3Fh              
        48 29 DA                            sub     rdx, rbx              
        48 69 D2 00 CA 9A 3B                imul    rdx, 3B9ACA00h        
        48 29 D1                            sub     rcx, rdx              
        48 BA 00 00 1A 3D EB 03 B2 A1       mov     rdx, 0A1B203EB3D1A0000h
        */
        $func1 = { 48 B8 CC 52 5A 9B A0 2F B8 44 48 F7 EB 48 C1 FA 1C 48 C1 FB 3F 48 29 DA 48 69 D2 00 CA 9A 3B 48 29 D1 48 BA 00 00 1A 3D EB 03 B2 A1 }

        /* Function Address: 0x639500 : aaa.com_bbb_menet.Send
        48 29 C7                            sub     rdi, rax              
        4C 89 C1                            mov     rcx, r8               
        48 29 C1                            sub     rcx, rax              
        49 89 FA                            mov     r10, rdi              
        48 F7 DF                            neg     rdi                   
        48 C1 FF 3F                         sar     rdi, 3Fh              
        48 21 C7                            and     rdi, rax              
        */
        $func2 = { 48 29 C7 4C 89 C1 48 29 C1 49 89 FA 48 F7 DF 48 C1 FF 3F 48 21 C7 }

        /* Function Address: 0x640b00 : aaa.com_bbb_meutil.GenerateRandomHex
        48 89 D6                            mov     rsi, rdx              
        48 69 CB 00 CA 9A 3B                imul    rcx, rbx, 3B9ACA00h   
        81 E6 FF FF FF 3F                   and     esi, 3FFFFFFFh        
        48 63 D6                            movsxd  rdx, esi              
        48 01 D1                            add     rcx, rdx              
        48 BA 00 00 1A 3D EB 03 B2 A1       mov     rdx, 0A1B203EB3D1A0000h
        */
        $func3 = { 48 89 D6 48 69 CB 00 CA 9A 3B 81 E6 FF FF FF 3F 48 63 D6 48 01 D1 48 BA 00 00 1A 3D EB 03 B2 A1 }

        /* Function Address: 0x6426a0 : aaa.com_bbb_meutil.init
        81 E2 FF FF FF 3F                   and     edx, 3FFFFFFFh        
        48 63 D2                            movsxd  rdx, edx              
        48 01 D1                            add     rcx, rdx              
        48 BA 00 00 1A 3D EB 03 B2 A1       mov     rdx, 0A1B203EB3D1A0000h
        */
        $func4 = { 81 E2 FF FF FF 3F 48 63 D2 48 01 D1 48 BA 00 00 1A 3D EB 03 B2 A1 }

        /* Function Address: 0x641e00 : aaa.com_bbb_meutil.Daemon2
        48 FF CF                            dec     rdi                   
        49 89 F8                            mov     r8, rdi               
        48 F7 DF                            neg     rdi                   
        48 C1 FF 3F                         sar     rdi, 3Fh              
        83 E7 10                            and     edi, 10h              
        48 01 FA                            add     rdx, rdi              
        */
        $func5 = { 48 FF CF 49 89 F8 48 F7 DF 48 C1 FF 3F 83 E7 10 48 01 FA }

        /* Function Address: 0x6421e0 : aaa.com_bbb_meutil.SimpleCommand
        31 C9                               xor     ecx, ecx              
        31 FF                               xor     edi, edi              
        BE 02 00 00 00                      mov     esi, 2                
        41 B8 01 00 00 00                   mov     r8d, 1                
        */
        $func6 = { 31 C9 31 FF BE 02 00 00 00 41 B8 01 00 00 00 }


    condition:
        (uint32(0) == 0x464C457F)
        and (elf.machine == elf.EM_X86_64)
        and (filesize < 9MB)
        and (filesize > 2MB)
        and ( 5 of ($func*) )
}
    