

import "elf"

rule malware_GobRAT_mips {
    meta:
        description = "Hunting GobRAT malware"
        author = "JPCERT/CC Incident Response Group"
        rule_usage = "Hunting"
        hash = "DAD92DDC28A5DBD65671A8F3E958A818113058BEDE10924046B493F0AB195F00"
    
    strings:
        /* Function Address: 0x2873ac : aaa.com_bbb_mecrypt.AesEncrypt
        5F 00 01 3C 61 CB 21 24             li      $at, 0x5ECB61         
        5F 00 03 3C 70 CB 63 24             li      $v1, (aLittleendianmo+0x7555) # "h2384185791015625: value of type AEAD_A"...
        FF FF 21 24                         addiu   $at, (aLittleendianmo+0x7545 - 0x5ECB61) # "f12345678abcdefgh2384185791015625: valu"...
        */
        $func0 = { 5F 00 01 3C 61 CB 21 24 5F 00 03 3C 70 CB 63 24 FF FF 21 24 }

        /* Function Address: 0x2cb72c : aaa.com_bbb_menet._ptr_CONN.Read
        20 00 BD 27                         addiu   $sp, 0x20             
        08 00 E0 03                         jr      $ra                   
        00 00 00 00                         nop                           
        57 00 01 3C 20 32 21 24             li      $at, asc_573220 # "\b"
        */
        $func1 = { 20 00 BD 27 08 00 E0 03 00 00 00 00 57 00 01 3C 20 32 21 24 }

        /* Function Address: 0x2d3af0 : aaa.com_bbb_meutil._debug
        00 00 00 00                         nop                           
        40 10 02 00                         sll     $v0, 1                
        C2 1F 01 00                         srl     $v1, $at, 31          
        25 10 62 00                         or      $v0, $v1, $v0         
        40 18 01 00                         sll     $v1, $at, 1           
        40 20 02 00                         sll     $a0, $v0, 1           
        C2 1F 03 00                         srl     $v1, 31               
        25 18 83 00                         or      $v1, $a0, $v1         
        B1 D7 17 3C 80 7F F7 36             li      $s7, 0xD7B17F80       
        21 20 77 00                         addu    $a0, $v1, $s7         
        2B 18 83 00                         sltu    $v1, $a0, $v1         
        C2 17 02 00                         srl     $v0, 31               
        0D 00 42 24                         addiu   $v0, 0xD              
        21 10 43 00                         addu    $v0, $v1              
        */
        $func2 = { 00 00 00 00 40 10 02 00 C2 1F 01 00 25 10 62 00 40 18 01 00 40 20 02 00 C2 1F 03 00 25 18 83 00 B1 D7 17 3C 80 7F F7 36 21 20 77 00 2B 18 83 00 C2 17 02 00 0D 00 42 24 21 10 43 00 }

        /* Function Address: 0x2cc89c : aaa.com_bbb_menet.GetMacAddress
        00 00 00 00                         nop                           
        3A 00 0A 24                         li      $t2, 0x3A  # ':'      
        25 40 06 00                         move    $t0, $a2              
        01 00 06 25                         addiu   $a2, $t0, 1           
        00 4E 07 00                         sll     $t1, $a3, 24          
        02 4F 09 00                         srl     $t1, 28               
        FF 00 29 31                         andi    $t1, 0xFF             
        5F 00 0B 3C 51 CB 6B 25             li      $t3, (aLittleendianmo+0x7536) # "0123456789abcdef12345678abcdefgh2384185"...
        21 48 69 01                         addu    $t1, $t3, $t1         
        */
        $func3 = { 00 00 00 00 3A 00 0A 24 25 40 06 00 01 00 06 25 00 4E 07 00 02 4F 09 00 FF 00 29 31 5F 00 0B 3C 51 CB 6B 25 21 48 69 01 }

        /* Function Address: 0x2d43b4 : aaa.com_bbb_meutil.DebugError
        27 00 00 00                         nor     $zero, $zero          
        25 08 00 00                         move    $at, $zero            
        01 00 04 24                         li      $a0, 1                
        C7 00 05 3C 78 EA A5 24             li      $a1, dword_C6EA78     
        25 30 00 00                         move    $a2, $zero            
        0F 00 00 00                         sync                          
        */
        $func4 = { 27 00 00 00 25 08 00 00 01 00 04 24 C7 00 05 3C 78 EA A5 24 25 30 00 00 0F 00 00 00 }

        /* Function Address: 0x2d61c0 : aaa.com_bbb_meutil.Daemon2
        00 00 00 00                         nop                           
        FF FF 84 24                         addiu   $a0, -1               
        23 30 04 00                         negu    $a2, $a0              
        C3 37 06 00                         sra     $a2, 31               
        08 00 C6 30                         andi    $a2, 8                
        21 18 C3 00                         addu    $v1, $a2, $v1         
        FF FF A6 24                         addiu   $a2, $a1, -1          
        2B 38 85 00                         sltu    $a3, $a0, $a1         
        */
        $func5 = { 00 00 00 00 FF FF 84 24 23 30 04 00 C3 37 06 00 08 00 C6 30 21 18 C3 00 FF FF A6 24 2B 38 85 00 }


    condition:
        (uint32(0) == 0x464C457F)
        and (filesize < 9MB)
        and (filesize > 2MB)
        and ( 6 of ($func*) )

}
    